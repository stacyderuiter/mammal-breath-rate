---
title: "Allometry of Mammalian Breathing Rates"
author: "Elliot Stielstra, Ethan Wilstermann, Simon Rylaarsdam, Stacy DeRuiter, Andreas Fahlman"
date: "7/25/2024"
format:
  html:
    embed-resources: true
    code-tools: true
editor: source
---

```{r}
#| label: setup 
#| include: false

library(tidyverse)
library(ggformula)
library(glmmTMB)
library(ggeffects)
library(readxl)
library(plotly)
library(DHARMa)
library(emmeans)

knitr::opts_chunk$set(
  # folder where images will be saved
  fig.path = 'figures/breath-rate-',
  # file type for image files (can also be eps, jpeg, ...)
  dev = 'png',
  # resolution for image files
  dpi = 300)
```

# Introduction

## Context and Goals

The objective with this analysis was to explore the allometric relationship between breathing frequency and body mass for mammals that live in different habitats. 

Unlike other studies, We aimed to only use data that were sampled under basal conditions; 1) adult animals, 2) not pregnant or lactating, 3) post-prandial (fasted), 4) at rest, and 5) in their thermoneutral zone. Although, we included animals at different activity levels, the final analysis focused on those that were inactive, so activity level 1. Also, not all animals may have fasted long enough to be post-prandial, like ruminants. 


```{r}
# Andreas' computer, your data file and where it is located
# breath_data <- read.csv("breath-rate.csv")#aLL ACTIVITY LEVELS
#breath_data <- read.csv("breath-rate-activity-level1.csv")#only acitivity level 1
# Stacy's computer
breath_data <- read.csv('data/breath-rate.csv')
#extract the variables of interest
breath_data <- breath_data |>
  select(log_fr, log_Mb, habitat, order, family, genus, species,
         breath_rate, body_mass, sex, 
         activity_level, individual_name, common_name, age, temp, location) |>
  # force activity level variable to be categorical
  mutate(activity_level = factor(activity_level)) |>
  na.omit()

breath_data <- breath_data |>
  arrange(order, common_name)

glimpse(breath_data)
```

## Exploratory Graphs separating habitat

```{r}
gf_point(log_fr ~ log_Mb | habitat, alpha=0.1, data = breath_data) 
```

```{r}
gf_point(log_fr ~ log_Mb, data = breath_data, color= ~habitat)|> 
    gf_labs(x = "Log 10 Body mass (kg)",
           y = "Log 10 Breaths per Minute",
           color = "Habitat")
```


# Fitting the model

Full model

Model that includes consideration (phylogenetic constrast) of order, genus and species. Model includes body mass, activity, temperature of either water or air (where the animal was measured) and habitat. The model also accounts for differences in slopes for animals of different habitats.

```{r}
model_full <- glmmTMB(log_fr ~ log_Mb * habitat + activity_level + temp + # location +
                         (1 | order/family/genus/species) + (1 | individual_name), 
                      data = breath_data)
summary(model_full)
```


## Model Assessment

Model assessment to support that the model accurately represents patterns found within the data.

```{r}
breath_data <- breath_data |>
  mutate(preds = predict(model_full),
         resids = resid(model_full))
```

# Lack of Non-Linearity

```{r}
gf_point(resids ~ preds, data = breath_data, alpha = 0.2)
```

The plot examines the relationship between the residuals and the
predicted values. Upon visual inspection, the plot does not demonstrate
a any trends. The spread of the points is also relatively constant as a function of predicted value (given that there are fewer large mass animals) so the condition of constant residual variance also seems to be met.

Because of the random effects it might be better to used scaled residuals to check these conditions:

```{r}
sim_res <- simulateResiduals(model_full)
plotResiduals(sim_res, quantreg = FALSE)
```
Similarly, there is no evidence of systematic changes with scaled residuals

# Independence of Residuals

```{r}
acf(resid(model_full))
```

The ACF value at lag 1 and 2 are slightly worrisome but probably acceptable, possibly related to the fact there are many small RE groups (there are no indications of strong non-independence of the residuals).


# Normality of Residuals

```{r}
gf_histogram(~resids, data = breath_data, bins = 20)
```

The distribution of the residuals is unimodal and pretty symmetric, so there are not worries about the residual normality condition.



## Model Analysis

```{r}
car::Anova(model_full)
```

The ANOVA output shows a strong dependence of body mass, habitat and activity level, and provides moderate evidence of an interaction between habitat and body mass. The data also provides strong evidence of a difference by location, but note that only semi-aquatic mammals are measured in both locations (as all aquatic are only measured in water and all terrestrial in air). So, part of the location effect may be driven by overall terrestrial-aquatic differences. Surprisingly, location suggests that breathing frequency is lower in water than on land for semi-aquatic mammals.  

To dig deeper into the relationship between breath rate, mass, and habitat, we used the R package `emmeans` and its function `emtrends()` to do a post-hoc comparison of the slopes for each habitat. 

For each pair of habitats, we will test the null hypothesis that the *difference in slopes* is 0. 

(So, a small p-value for a pair means the slopes of those two habitats are different.) 

Since we are doing several hypothesis tests together, the chances of a false positive are elevated; to compensate, `emtrends()` has used Tukey's method to adjust the p-values before reporting.

```{r}
slope_comparison <- emtrends(model_full, 
         pairwise ~ habitat,
         var = "log_Mb")
slope_comparison
slope_comparison <- as.data.frame(slope_comparison$contrasts)
slope_comparison
```

The top part of the output gives a slope for each habitat with CIs. The lower "contrasts" part is where we'll focus now: it gives the p-values for the tests comparing each pair of habitats.

We have very weak (for aquatic/terrestrial, p = `r slope_comparison["aquatic - terrestrial", "p.value"]`) and moderately strong (for semiaquatic - terrestrial, p = `r slope_comparison["semiaquatic - terrestrial", "p.value"]`) evidence that terrestrial habitats are different from the others. But we have no evidence (p =`r slope_comparison["aquatic - semiaquatic", "p.value"]`) that the slopes are different between aquatic and semiaquatic.

What about doing something similar for the intercepts?

```{r}
int_comparison <- emmeans(model_full, 
         pairwise ~ habitat,
         var = "log_Mb")
slope_comparison
slope_comparison <- as.data.frame(slope_comparison$contrasts)
slope_comparison
```

## Prediction Plot

**Log-log Scale Prediction Plot**

For the prediction plots shown below, the other predictors in the model but not shown in the plot were held fixed at the following values:

- activity level: 1
- location: water for aquatic, air for terrestrial, both for semiaquatic

We also add in data from Mortola and He:

```{r}
mortola <- read_excel('data/additional-species.xlsx',
                              sheet = 'mortola') |>
  mutate(log_Mb = log10(`Body mass`),
         body_mass = `Body mass`,
         log_fr = log10(fr),
         breath_rate = fr,
         common_name = species) 

he <- read_excel('data/additional-species.xlsx',
                              sheet = 'He') |>
  filter(`Common Name` %in% c('hippo', 'walrus', 'polar bear', 
                              'african clawless otter', 'river otter',
                              'beaver')) |>
  rename(log_Mb = `Log of Mass`,
         body_mass = `Mass (kg)`,
         breath_rate = `Breathing Frequency (br/min)`
         ) |>
  mutate(log_fr = log10(breath_rate),
         habitat = 'semiaquatic',
         common_name = `Common Name`)
```

```{r}
predictoutput <- ggpredict(model_full,
                           terms = c('log_Mb', 'habitat'),
                           condition = c(activity_level = 1)) 

# |>
#   filter((facet == 'air' & group %in% c('terrestrial', 'semiaquatic')) |
#            facet == 'water' & group %in% c('aquatic', 'semiaquatic'))



natural_preds <- data.frame(mass = 10^predictoutput$x,
                            breaths = 10^predictoutput$predicted,
                            conf_low = 10^predictoutput$conf.low,
                            conf_hi = 10^predictoutput$conf.high,
                            habitat = predictoutput$group #,
                            # location = predictoutput$facet
                            )
# plot data
gf_point(breath_rate ~ body_mass | habitat, # color = ~location, 
         data = breath_data,
         alpha = 0.3) |>
  # with log scales on both axes
  gf_refine(scale_x_log10(), scale_y_log10()) |>
  gf_labs(x = 'Body Mass (kg)',
          y = 'Breaths per Minute') |>
  # add the predictions now
  gf_line(breaths ~ mass | habitat,
         # color = ~location,
          data = natural_preds,
    inherit = FALSE) |>
  gf_ribbon(conf_low + conf_hi ~ mass | habitat,
          #  color = ~location, fill = ~location,
            data = natural_preds,
            inherit = FALSE)
```

**Interactive Prediction Plot**

```{r}
gf_point(breath_rate ~ body_mass | habitat, data = breath_data,
         alpha = 0.3, label = ~common_name, color = ~order) |>
  # with log scales on both axes
  gf_refine(scale_x_log10(), scale_y_log10()) |>
  gf_labs(x = 'Body Mass (kg)',
          y = 'Breaths per Minute') |>
  # add the predictions now
  gf_line(breaths ~ mass | habitat,
         # color = ~location,
          data = natural_preds,
    inherit = FALSE) |>
  gf_ribbon(conf_low + conf_hi ~ mass | habitat,
           # color = ~location,
            data = natural_preds,
            inherit = FALSE) |>
  # add in He species -- grey squares
  gf_point(breath_rate ~ body_mass | habitat,
           inherit = FALSE,
           data = he,
           color = 'grey44',
           label = ~common_name,
           shape = 15) |>
  # add in Mortola species -- grey triangles
  gf_point(breath_rate ~ body_mass | habitat,
           inherit = FALSE,
           data = mortola,
           color = 'grey44',
           label = ~common_name,
           shape = 17) |>
  ggplotly()
```



## Contact Information

Elliot Stielstra ees45\@calvin.edu 616-634-3423

Simon Rylaarsdam Simon.c.Rylaarsdam\@gmail.com 616-752-0007

Ethan Wilstermann 3wilster\@gmail.com 616-617-1436
